<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance MVP Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Fix dropdown text color */
        select option {
            background-color: #1e293b;
            color: white;
        }
        
        /* COLOR THEME VARIABLES - CHANGE THESE TO CUSTOMIZE! */
        :root {
            --primary-gradient-start: #9333ea;  /* Purple */
            --primary-gradient-end: #2563eb;    /* Blue */
            --bg-gradient-start: #0f172a;       /* Slate 900 */
            --bg-gradient-mid: #581c87;         /* Purple 900 */
            --bg-gradient-end: #0f172a;         /* Slate 900 */
            --accent-green: #22c55e;            /* Green 500 */
            --accent-red: #ef4444;              /* Red 500 */
            --accent-blue: #3b82f6;             /* Blue 500 */
            --accent-purple: #a855f7;           /* Purple 500 */
            --accent-yellow: #fbbf24;           /* Yellow 400 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnjwzIOIkq8eJquf2MBbktyxw3jpjEPtc",
            authDomain: "kc-mvp-selector.firebaseapp.com",
            projectId: "kc-mvp-selector",
            storageBucket: "kc-mvp-selector.firebasestorage.app",
            messagingSenderId: "212133638001",
            appId: "1:212133638001:web:0c6e6a45c847f848ffd0d0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // SVG Icons
        const Icons = {
            Users: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
            Award: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"></circle><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"></path></svg>`,
            Crown: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></svg>`,
            Trophy: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>`,
            Plus: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            Trash2: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            X: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            LogOut: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`
        };

        // App State
        let state = {
            user: null,
            members: [],
            events: [],
            mvpHistory: [],
            titleHistory: [],
            selectedEvent: '',
            isCS: false,
            isTitles: false,
            isManualMVP: false,
            selectedTitle: 'Earl',
            selectedMemberForTitle: '',
            selectedMemberForManual: '',
            showAdminModal: false,
            showEventModal: false,
            showRenameModal: false,
            newMemberName: '',
            newEventName: '',
            renameMemberOld: '',
            renameMemberNew: '',
            loading: true,
            loginEmail: '',
            loginPassword: ''
        };

        const defaultWeight = 10;
        const penaltyWeight = 1;
        const penaltyMultiplier = 0.5;

        // Firebase Helper Functions
        async function loadDataFromFirebase() {
            try {
                const userId = auth.currentUser.uid;
                
                // Load members
                const membersDoc = await db.collection('users').doc(userId).collection('data').doc('members').get();
                if (membersDoc.exists) {
                    state.members = membersDoc.data().list || [];
                }

                // Load MVP history
                const mvpDoc = await db.collection('users').doc(userId).collection('data').doc('mvpHistory').get();
                if (mvpDoc.exists) {
                    state.mvpHistory = mvpDoc.data().list || [];
                }

                // Load title history
                const titleDoc = await db.collection('users').doc(userId).collection('data').doc('titleHistory').get();
                if (titleDoc.exists) {
                    state.titleHistory = titleDoc.data().list || [];
                }

                // Load events
                const eventsDoc = await db.collection('users').doc(userId).collection('data').doc('events').get();
                if (eventsDoc.exists) {
                    state.events = eventsDoc.data().list || [];
                } else {
                    // Set default events if none exist
                    state.events = ['Bandit Attack', 'Battle Royale', 'Kingdom War', 'Territory War', 'Alliance War'];
                    await saveToFirebase('events', state.events);
                }

                state.loading = false;
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                state.loading = false;
                render();
            }
        }

        async function saveToFirebase(docName, data) {
            try {
                const userId = auth.currentUser.uid;
                await db.collection('users').doc(userId).collection('data').doc(docName).set({ list: data });
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Please try again.');
            }
        }

        // Auth Functions
        function handleLogin(e) {
            e.preventDefault();
            state.loading = true;
            render();

            auth.signInWithEmailAndPassword(state.loginEmail, state.loginPassword)
                .then(() => {
                    // User logged in, loadDataFromFirebase will be called by onAuthStateChanged
                })
                .catch((error) => {
                    state.loading = false;
                    alert('Login failed: ' + error.message);
                    render();
                });
        }

        function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                auth.signOut();
            }
        }

        // Import/Export Functions
        function handleImportMembers(fileContent) {
            try {
                const lines = fileContent.split('\n').filter(l => l.trim());
                const imported = [];
                
                // Skip header if exists
                const startIdx = lines[0].match(/^Name,Eligible$/i) ? 1 : 0;
                
                for (let i = startIdx; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts[0].trim()) {
                        const name = parts[0].trim();
                        const eligible = parts.length > 1 ? parts[1].trim().toLowerCase() === 'true' : true;
                        
                        // Don't duplicate existing members
                        if (!state.members.find(m => m.name === name)) {
                            imported.push({ name, eligible });
                        }
                    }
                }
                
                if (imported.length > 0) {
                    state.members.push(...imported);
                    saveToFirebase('members', state.members);
                    alert(`Successfully imported ${imported.length} members!`);
                    render();
                } else {
                    alert('No new members to import.');
                }
            } catch (error) {
                alert('Error importing members: ' + error.message);
            }
        }

        function handleImportMVPHistory(fileContent) {
            try {
                const lines = fileContent.split('\n').filter(l => l.trim());
                let imported = 0;
                
                for (const line of lines) {
                    const parts = line.split('||').map(p => p.trim());
                    if (parts.length >= 3) {
                        const entry = {
                            date: parts[0],
                            event: parts[1],
                            member: parts[2],
                            timestamp: new Date(parts[0]).toISOString()
                        };
                        
                        // Check if entry already exists
                        const exists = state.mvpHistory.some(e => 
                            e.date === entry.date && e.event === entry.event && e.member === entry.member
                        );
                        
                        if (!exists) {
                            state.mvpHistory.push(entry);
                            imported++;
                        }
                    }
                }
                
                if (imported > 0) {
                    // Keep only recent history based on member count
                    state.mvpHistory = state.mvpHistory.slice(-Math.max(state.members.length, 35));
                    saveToFirebase('mvpHistory', state.mvpHistory);
                    alert(`Successfully imported ${imported} MVP history entries!`);
                    render();
                } else {
                    alert('No new MVP history to import.');
                }
            } catch (error) {
                alert('Error importing MVP history: ' + error.message);
            }
        }

        function handleImportTitleHistory(fileContent) {
            try {
                const lines = fileContent.split('\n').filter(l => l.trim());
                let imported = 0;
                
                for (const line of lines) {
                    const parts = line.split('||').map(p => p.trim());
                    if (parts.length >= 3) {
                        const entry = {
                            timestamp: parts[0],
                            title: parts[1],
                            member: parts[2]
                        };
                        
                        // Check if entry already exists
                        const exists = state.titleHistory.some(e => 
                            e.timestamp === entry.timestamp && e.title === entry.title && e.member === entry.member
                        );
                        
                        if (!exists) {
                            state.titleHistory.push(entry);
                            imported++;
                        }
                    }
                }
                
                if (imported > 0) {
                    state.titleHistory = state.titleHistory.slice(-30);
                    saveToFirebase('titleHistory', state.titleHistory);
                    alert(`Successfully imported ${imported} title history entries!`);
                    render();
                } else {
                    alert('No new title history to import.');
                }
            } catch (error) {
                alert('Error importing title history: ' + error.message);
            }
        }

        function showImportDialog() {
            const importType = prompt('What would you like to import?\\n\\n1 - Members (members.csv)\\n2 - MVP History (mvp_history_details.txt)\\n3 - Title History (mvp_title.txt)\\n\\nEnter number (1, 2, or 3):');
            
            if (!importType || !['1', '2', '3'].includes(importType)) {
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = importType === '1' ? '.csv' : '.txt';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    
                    if (importType === '1') {
                        handleImportMembers(content);
                    } else if (importType === '2') {
                        handleImportMVPHistory(content);
                    } else if (importType === '3') {
                        handleImportTitleHistory(content);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function exportData() {
            const exportType = prompt('What would you like to export?\\n\\n1 - Members\\n2 - MVP History\\n3 - Title History\\n4 - All Data\\n\\nEnter number (1, 2, 3, or 4):');
            
            if (!exportType || !['1', '2', '3', '4'].includes(exportType)) {
                return;
            }
            
            let data, filename, mimeType;
            
            if (exportType === '1') {
                data = 'Name,Eligible\\n' + state.members.map(m => `${m.name},${m.eligible}`).join('\\n');
                filename = 'members.csv';
                mimeType = 'text/csv';
            } else if (exportType === '2') {
                data = state.mvpHistory.map(e => `${e.date} || ${e.event} || ${e.member}`).join('\\n');
                filename = 'mvp_history_details.txt';
                mimeType = 'text/plain';
            } else if (exportType === '3') {
                data = state.titleHistory.map(e => `${e.timestamp} || ${e.title} || ${e.member}`).join('\\n');
                filename = 'mvp_title_history.txt';
                mimeType = 'text/plain';
            } else if (exportType === '4') {
                data = JSON.stringify({
                    members: state.members,
                    mvpHistory: state.mvpHistory,
                    titleHistory: state.titleHistory,
                    events: state.events
                }, null, 2);
                filename = 'mvp_selector_backup.json';
                mimeType = 'application/json';
            }
            
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Exported ${filename} successfully!`);
        }
        function getEligibleMembers() {
            return state.members.filter(m => m.eligible);
        }

        function getMVPCount(memberName) {
            const recentLimit = state.members.length;
            const recentMVPs = state.mvpHistory.slice(-recentLimit);
            return recentMVPs.filter(h => h.member === memberName).length;
        }

        function calculatePenaltyWeight(mvpCount) {
            if (mvpCount === 0) return defaultWeight;
            const calculatedPenalty = penaltyWeight * Math.pow(penaltyMultiplier, mvpCount);
            return Math.max(0.1, calculatedPenalty);
        }

        function addMember() {
            const name = state.newMemberName.trim();
            if (!name) {
                alert('Please enter a member name.');
                return;
            }
            if (state.members.find(m => m.name === name)) {
                alert('Member already exists.');
                return;
            }
            state.members.push({ name: name, eligible: true });
            state.newMemberName = '';
            saveToFirebase('members', state.members);
            render();
        }

        function removeMember(name) {
            if (confirm(`Are you sure you want to remove ${name}?`)) {
                state.members = state.members.filter(m => m.name !== name);
                saveToFirebase('members', state.members);
                render();
            }
        }

        function toggleEligibility(name) {
            state.members = state.members.map(m => 
                m.name === name ? { ...m, eligible: !m.eligible } : m
            );
            saveToFirebase('members', state.members);
            render();
        }

        function selectAllMembers() {
            state.members = state.members.map(m => ({ ...m, eligible: true }));
            saveToFirebase('members', state.members);
            render();
        }

        function deselectAllMembers() {
            state.members = state.members.map(m => ({ ...m, eligible: false }));
            saveToFirebase('members', state.members);
            render();
        }

        function assignTitle() {
            if (!state.selectedMemberForTitle) {
                alert('Please select a member for title assignment.');
                return;
            }
            if (!state.selectedTitle) {
                alert('Please select a title.');
                return;
            }

            const origin = confirm('Was this title earned through Alliance efforts?\\n\\nClick OK for Alliance, Cancel for Individual');
            const titleSuffix = origin ? ' (Ally)' : '';
            
            const entry = {
                timestamp: new Date().toISOString(),
                title: state.selectedTitle + titleSuffix,
                member: state.selectedMemberForTitle
            };

            state.titleHistory.push(entry);
            state.titleHistory = state.titleHistory.slice(-30);
            saveToFirebase('titleHistory', state.titleHistory);
            
            alert(`üèÖ Title '${state.selectedTitle}' assigned to '${state.selectedMemberForTitle}'`);
            state.isTitles = false;
            render();
        }

        function selectMVP() {
            if (state.isTitles) {
                assignTitle();
                return;
            }

            const eligibleMembers = getEligibleMembers();
            if (eligibleMembers.length === 0) {
                alert('No eligible members selected!');
                return;
            }

            if (!state.selectedEvent) {
                alert('Please select an event.');
                return;
            }

            const eventName = state.isCS ? `${state.selectedEvent} CS` : state.selectedEvent;
            let selectedMVP;
            let mvpWeight;

            if (state.isManualMVP) {
                if (!state.selectedMemberForManual) {
                    alert('Please select a member for manual MVP.');
                    return;
                }
                selectedMVP = state.selectedMemberForManual;
                const mvpCount = getMVPCount(selectedMVP);
                mvpWeight = mvpCount > 0 ? calculatePenaltyWeight(mvpCount) : defaultWeight;
            } else {
                const recentLimit = state.members.length;
                const recentMVPs = state.mvpHistory.slice(-recentLimit);
                const recentMemberNames = recentMVPs.map(h => h.member);

                const membersNotInHistory = eligibleMembers.filter(m => !recentMemberNames.includes(m.name));
                
                let weightedList = [];

                if (membersNotInHistory.length > 0) {
                    membersNotInHistory.forEach(member => {
                        for (let i = 0; i < defaultWeight; i++) {
                            weightedList.push(member.name);
                        }
                    });
                } else {
                    eligibleMembers.forEach(member => {
                        const mvpCount = getMVPCount(member.name);
                        const penalizedWeight = calculatePenaltyWeight(mvpCount);
                        const weightEntries = Math.max(1, Math.round(penalizedWeight * 10));
                        for (let i = 0; i < weightEntries; i++) {
                            weightedList.push(member.name);
                        }
                    });
                }

                selectedMVP = weightedList[Math.floor(Math.random() * weightedList.length)];
                const mvpCount = getMVPCount(selectedMVP);
                mvpWeight = mvpCount > 0 ? calculatePenaltyWeight(mvpCount) : defaultWeight;
            }

            const mvpCount = getMVPCount(selectedMVP);
            const message = `${state.isManualMVP ? 'Manual' : 'Random'} selection: '${selectedMVP}' (weight: ${mvpWeight.toFixed(2)})${mvpCount > 0 ? ` (appears ${mvpCount} time(s) in recent history)` : ''} for '${eventName}'.\\n\\nConfirm participation and eligibility?`;

            if (confirm(message)) {
                const entry = {
                    date: new Date().toISOString().split('T')[0],
                    event: eventName,
                    member: selectedMVP,
                    timestamp: new Date().toISOString()
                };
                state.mvpHistory.push(entry);
                state.mvpHistory = state.mvpHistory.slice(-state.members.length);
                saveToFirebase('mvpHistory', state.mvpHistory);
                alert(`‚úÖ MVP '${selectedMVP}' logged for '${eventName}'`);
                render();
            }
        }

        function getTitleColor(title) {
            if (title.includes('Earl')) return 'bg-blue-200';
            if (title.includes('Duke')) return 'bg-purple-300';
            if (title.includes('King')) return 'bg-yellow-300';
            return 'bg-gray-300';
        }

        function isTitleExpired(timestamp) {
            const now = new Date();
            const titleDate = new Date(timestamp);
            const daysDiff = (now - titleDate) / (1000 * 60 * 60 * 24);
            return daysDiff >= 30;
        }

        // Render Functions
        function render() {
            const root = document.getElementById('root');
            
            if (state.loading) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center">
                        <div class="text-center">
                            <div class="spinner mx-auto mb-4"></div>
                            <p class="text-white text-xl">Loading...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (!state.user) {
                renderLoginScreen(root);
                return;
            }

            renderMainApp(root);
        }

        function renderLoginScreen(root) {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
                    <div class="bg-white/10 backdrop-blur-lg rounded-lg shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="inline-block mb-4">${Icons.Trophy()}</div>
                            <h1 class="text-3xl font-bold text-white mb-2">Alliance MVP Selector</h1>
                            <p class="text-purple-200">King's Choice - Sign In</p>
                        </div>
                        
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-white mb-2 font-semibold">Email</label>
                                <input 
                                    type="email" 
                                    id="loginEmail"
                                    value="${state.loginEmail}"
                                    placeholder="your-email@example.com"
                                    class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 placeholder-white/50 focus:outline-none focus:border-white/50"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2 font-semibold">Password</label>
                                <input 
                                    type="password" 
                                    id="loginPassword"
                                    value="${state.loginPassword}"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    class="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 placeholder-white/50 focus:outline-none focus:border-white/50"
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                class="w-full bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition"
                            >
                                Sign In
                            </button>
                        </form>
                        
                        <p class="text-white/50 text-sm text-center mt-6">
                            Secure login with Firebase Authentication
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('loginEmail').addEventListener('input', (e) => {
                state.loginEmail = e.target.value;
            });
            document.getElementById('loginPassword').addEventListener('input', (e) => {
                state.loginPassword = e.target.value;
            });
        }

        function renderMainApp(root) {
            const eligibleCount = getEligibleMembers().length;
            const sortedMembers = [...state.members].sort((a, b) => a.name.localeCompare(b.name));
            const sortedEvents = [...state.events].sort((a, b) => a.localeCompare(b));
            const sortedEligibleMembers = getEligibleMembers().sort((a, b) => a.name.localeCompare(b.name));
            const recentMVPs = [...state.mvpHistory].reverse().slice(0, 35);
            const recentTitles = [...state.titleHistory].reverse().slice(0, 30);

            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg shadow-2xl p-6 mb-6">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10">${Icons.Trophy()}</div>
                                    <div>
                                        <h1 class="text-3xl font-bold text-white">Alliance MVP Selector</h1>
                                        <p class="text-purple-200">King's Choice - Synced with Firebase</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="state.showAdminModal = true; render();" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                                        <span class="w-5 h-5">${Icons.Users()}</span>
                                        Member Admin
                                    </button>
                                    <button onclick="state.showEventModal = true; render();" class="bg-purple-500/50 hover:bg-purple-600/50 text-white px-4 py-2 rounded-lg transition">
                                        üìÖ Events
                                    </button>
                                    <button onclick="showImportDialog()" class="bg-blue-500/50 hover:bg-blue-600/50 text-white px-4 py-2 rounded-lg transition">
                                        üì• Import
                                    </button>
                                    <button onclick="exportData()" class="bg-green-500/50 hover:bg-green-600/50 text-white px-4 py-2 rounded-lg transition">
                                        üì§ Export
                                    </button>
                                    <button onclick="handleLogout()" class="bg-red-500/50 hover:bg-red-600/50 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                                        <span class="w-5 h-5">${Icons.LogOut()}</span>
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="bg-white/10 backdrop-blur-lg rounded-lg shadow-xl p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-white mb-2 font-semibold">Select Event</label>
                                    <select onchange="state.selectedEvent = this.value; render();" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                        <option value="">-- Select Event --</option>
                                        ${sortedEvents.map(event => `<option value="${event}" ${state.selectedEvent === event ? 'selected' : ''}>${event}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="flex items-end gap-2">
                                    <label class="flex items-center gap-2 text-white cursor-pointer">
                                        <input type="checkbox" ${state.isCS ? 'checked' : ''} onchange="state.isCS = this.checked; render();" class="w-5 h-5" />
                                        <span class="font-semibold">CS</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white cursor-pointer ml-4">
                                        <input type="checkbox" ${state.isManualMVP ? 'checked' : ''} ${state.isTitles ? 'disabled' : ''} onchange="state.isManualMVP = this.checked; render();" class="w-5 h-5" />
                                        <span class="font-semibold">Manual MVP</span>
                                    </label>
                                </div>

                                <div class="flex items-end gap-2">
                                    <label class="flex items-center gap-2 text-white cursor-pointer">
                                        <input type="checkbox" ${state.isTitles ? 'checked' : ''} onchange="state.isTitles = this.checked; if(this.checked) state.isManualMVP = false; render();" class="w-5 h-5" />
                                        <span class="font-semibold">Titles</span>
                                    </label>
                                </div>

                                ${state.isTitles ? `
                                    <div>
                                        <label class="block text-white mb-2 font-semibold">Member</label>
                                        <select onchange="state.selectedMemberForTitle = this.value; render();" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                            <option value="">-- Select Member --</option>
                                            ${sortedMembers.map(m => `<option value="${m.name}" ${state.selectedMemberForTitle === m.name ? 'selected' : ''}>${m.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-white mb-2 font-semibold">Title</label>
                                        <select onchange="state.selectedTitle = this.value; render();" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                            <option value="Earl" ${state.selectedTitle === 'Earl' ? 'selected' : ''}>Earl</option>
                                            <option value="Duke" ${state.selectedTitle === 'Duke' ? 'selected' : ''}>Duke</option>
                                            <option value="King" ${state.selectedTitle === 'King' ? 'selected' : ''}>King</option>
                                        </select>
                                    </div>
                                ` : ''}

                                ${state.isManualMVP && !state.isTitles ? `
                                    <div>
                                        <label class="block text-white mb-2 font-semibold">Select Member</label>
                                        <select onchange="state.selectedMemberForManual = this.value; render();" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                            <option value="">-- Select Member --</option>
                                            ${sortedEligibleMembers.map(m => `<option value="${m.name}" ${state.selectedMemberForManual === m.name ? 'selected' : ''}>${m.name}</option>`).join('')}
                                        </select>
                                    </div>
                                ` : ''}
                            </div>

                            <button type="button" id="selectMvpBtn" class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                                <span class="w-6 h-6">${Icons.Award()}</span>
                                ${state.isTitles ? 'Assign Title' : 'Select MVP'}
                            </button>
                        </div>

                        <!-- Main Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Members Panel -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-lg shadow-xl p-6">
                                <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                        <span class="w-6 h-6">${Icons.Users()}</span>
                                        Alliance Members (${eligibleCount}/${state.members.length} Eligible)
                                    </h2>
                                    <div class="flex gap-2">
                                        <button type="button" id="selectAllBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition">Select All</button>
                                        <button type="button" id="deselectAllBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">Deselect All</button>
                                    </div>
                                </div>
                                
                                <div class="bg-black/20 rounded-lg p-4 max-h-96 overflow-y-auto">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        ${sortedMembers.map(member => `
                                            <label class="flex items-center gap-2 text-white cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                                <input type="checkbox" ${member.eligible ? 'checked' : ''} onchange="toggleEligibility('${member.name}')" class="w-5 h-5" />
                                                <span>${member.name}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- History Panels -->
                            <div class="space-y-6">
                                <!-- Recent MVPs -->
                                <div class="bg-white/10 backdrop-blur-lg rounded-lg shadow-xl p-6">
                                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                        <span class="w-6 h-6 text-yellow-400">${Icons.Trophy()}</span>
                                        Recent MVPs
                                    </h2>
                                    <div class="bg-black/20 rounded-lg p-4 max-h-64 overflow-y-auto">
                                        ${recentMVPs.length > 0 ? recentMVPs.map(entry => `
                                            <div class="text-white text-sm mb-2 pb-2 border-b border-white/10">
                                                ${entry.date} || ${entry.event} || ${entry.member}
                                            </div>
                                        `).join('') : '<p class="text-white/50 text-center">No MVP history yet.</p>'}
                                    </div>
                                </div>

                                <!-- Recent Titles -->
                                <div class="bg-white/10 backdrop-blur-lg rounded-lg shadow-xl p-6">
                                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                        <span class="w-6 h-6 text-yellow-400">${Icons.Crown()}</span>
                                        Recent Titles
                                    </h2>
                                    <div class="bg-black/20 rounded-lg p-4 max-h-48 overflow-y-auto">
                                        ${recentTitles.length > 0 ? recentTitles.map(entry => {
                                            const expired = isTitleExpired(entry.timestamp);
                                            const colorClass = expired ? 'bg-gray-400' : getTitleColor(entry.title);
                                            const dateStr = new Date(entry.timestamp).toISOString().split('T')[0];
                                            return `
                                                <div class="flex items-center gap-2 mb-2 pb-2 border-b border-white/10">
                                                    <div class="w-5 h-5 rounded ${colorClass}"></div>
                                                    <span class="text-white text-sm">${dateStr} || ${entry.title} || ${entry.member}</span>
                                                </div>
                                            `;
                                        }).join('') : '<p class="text-white/50 text-center">No title history yet.</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="text-center text-white/50 mt-8 text-sm">
                            ¬©2025 - Flominator - Made for King's Choice - Firebase Synced Version
                        </div>
                    </div>

                    <!-- Admin Modal -->
                    ${state.showAdminModal ? `
                        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                        <span class="w-7 h-7">${Icons.Users()}</span>
                                        Member Administration
                                    </h2>
                                    <button onclick="state.showAdminModal = false; render();" class="text-white hover:text-red-400 transition">
                                        <span class="w-6 h-6">${Icons.X()}</span>
                                    </button>
                                </div>

                                <div class="mb-6">
                                    <label class="block text-white mb-2 font-semibold">Add New Member</label>
                                    <div class="flex gap-2">
                                        <input 
                                            type="text" 
                                            id="newMemberInput"
                                            value="${state.newMemberName}"
                                            placeholder="Enter member name"
                                            class="flex-1 px-4 py-2 rounded-lg bg-white/10 text-white border border-white/30 placeholder-white/50"
                                        />
                                        <button type="button" id="addMemberBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition">
                                            <span class="w-5 h-5">${Icons.Plus()}</span>
                                            Add
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <button onclick="state.showRenameModal = true; state.showAdminModal = false; render();" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                        ‚úèÔ∏è Rename Member
                                    </button>
                                </div>

                                <div>
                                    <h3 class="text-white font-semibold mb-3">Alliance Members</h3>
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        ${sortedMembers.map(member => `
                                            <div class="bg-white/10 rounded-lg p-3 flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-white font-medium">${member.name}</span>
                                                    <span class="text-sm px-2 py-1 rounded ${member.eligible ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}">
                                                        ${member.eligible ? '‚úì Eligible' : '‚úó Not Eligible'}
                                                    </span>
                                                </div>
                                                <button onclick="removeMember('${member.name}')" class="removeMemberBtn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition" data-member-name="${member.name}">
                                                    <span class="w-4 h-4">${Icons.Trash2()}</span>
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <button onclick="state.showAdminModal = false; render();" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    Close
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Event Modal -->
                    ${state.showEventModal ? `
                        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                        üìÖ
                                        Event Management
                                    </h2>
                                    <button onclick="state.showEventModal = false; render();" class="text-white hover:text-red-400 transition">
                                        <span class="w-6 h-6">${Icons.X()}</span>
                                    </button>
                                </div>

                                <div class="mb-6">
                                    <label class="block text-white mb-2 font-semibold">Add New Event</label>
                                    <div class="flex gap-2">
                                        <input 
                                            type="text" 
                                            id="newEventInput"
                                            value="${state.newEventName}"
                                            placeholder="Enter event name"
                                            class="flex-1 px-4 py-2 rounded-lg bg-white/10 text-white border border-white/30 placeholder-white/50"
                                        />
                                        <button type="button" id="addEventBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition">
                                            <span class="w-5 h-5">${Icons.Plus()}</span>
                                            Add
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-white font-semibold mb-3">Events</h3>
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        ${sortedEvents.map((event, idx) => `
                                            <div class="bg-white/10 rounded-lg p-3 flex items-center justify-between">
                                                <span class="text-white font-medium">${event}</span>
                                                <button type="button" data-event-name="${event}" class="removeEventBtn bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition">
                                                    <span class="w-4 h-4">${Icons.Trash2()}</span>
                                                </button>
                                            </div>
                                        `).join('')}
                                        ${state.events.length === 0 ? '<p class="text-white/50 text-center py-4">No events yet. Add your first event above!</p>' : ''}
                                    </div>
                                </div>

                                <button onclick="state.showEventModal = false; render();" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    Close
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Rename Member Modal -->
                    ${state.showRenameModal ? `
                        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-2xl p-6 max-w-md w-full">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                        ‚úèÔ∏è Rename Member
                                    </h2>
                                    <button onclick="state.showRenameModal = false; state.showAdminModal = true; render();" class="text-white hover:text-red-400 transition">
                                        <span class="w-6 h-6">${Icons.X()}</span>
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-white mb-2 font-semibold">Current Member Name</label>
                                    <select 
                                        id="renameOldInput"
                                        class="w-full px-4 py-2 rounded-lg bg-white/10 text-white border border-white/30"
                                    >
                                        <option value="">-- Select Member --</option>
                                        ${sortedMembers.map(m => `<option value="${m.name}" ${state.renameMemberOld === m.name ? 'selected' : ''}>${m.name}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="mb-6">
                                    <label class="block text-white mb-2 font-semibold">New Member Name</label>
                                    <input 
                                        type="text" 
                                        id="renameNewInput"
                                        value="${state.renameMemberNew}"
                                        placeholder="Enter new name"
                                        class="w-full px-4 py-2 rounded-lg bg-white/10 text-white border border-white/30 placeholder-white/50"
                                    />
                                </div>

                                <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-3 mb-6">
                                    <p class="text-yellow-200 text-sm">
                                        ‚ö†Ô∏è This will rename the member across ALL data: members list, MVP history, and title history.
                                    </p>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="state.showRenameModal = false; state.showAdminModal = true; render();" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                        Cancel
                                    </button>
                                    <button type="button" id="renameMemberBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                        Rename
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Add event listener for new member input
            const newMemberInput = document.getElementById('newMemberInput');
            if (newMemberInput) {
                newMemberInput.addEventListener('input', (e) => {
                    state.newMemberName = e.target.value;
                });
                newMemberInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addMember();
                    }
                });
            }

            // Add event listener for new event input
            const newEventInput = document.getElementById('newEventInput');
            if (newEventInput) {
                newEventInput.addEventListener('input', (e) => {
                    state.newEventName = e.target.value;
                });
                newEventInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addEvent();
                    }
                });
            }

            // Add event listeners for rename member inputs
            const renameOldInput = document.getElementById('renameOldInput');
            if (renameOldInput) {
                renameOldInput.addEventListener('change', (e) => {
                    state.renameMemberOld = e.target.value;
                });
            }

            const renameNewInput = document.getElementById('renameNewInput');
            if (renameNewInput) {
                renameNewInput.addEventListener('input', (e) => {
                    state.renameMemberNew = e.target.value;
                });
                renameNewInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        renameMember();
                    }
                });
            }

            // Button event listeners
            const addMemberBtn = document.getElementById('addMemberBtn');
            if (addMemberBtn) {
                addMemberBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    addMember();
                });
            }

            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addEventBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    addEvent();
                });
            }

            const renameMemberBtn = document.getElementById('renameMemberBtn');
            if (renameMemberBtn) {
                renameMemberBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    renameMember();
                });
            }

            const selectMvpBtn = document.getElementById('selectMvpBtn');
            if (selectMvpBtn) {
                selectMvpBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectMVP();
                });
            }

            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectAllMembers();
                });
            }

            const deselectAllBtn = document.getElementById('deselectAllBtn');
            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    deselectAllMembers();
                });
            }

            // Event delegation for dynamically created remove buttons
            document.addEventListener('click', (e) => {
                // Remove Event button
                if (e.target.closest('.removeEventBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.removeEventBtn');
                    const eventName = btn.getAttribute('data-event-name');
                    if (eventName) {
                        removeEvent(eventName);
                    }
                }
                
                // Remove Member button
                if (e.target.closest('.removeMemberBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.removeMemberBtn');
                    const memberName = btn.getAttribute('data-member-name');
                    if (memberName) {
                        removeMember(memberName);
                    }
                }
            });
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                state.user = user;
                state.loading = true;
                render();
                loadDataFromFirebase();
            } else {
                state.user = null;
                state.loading = false;
                render();
            }
        });

        // Initial render
        render();
    </script>
</body>
</html>
